{"version":3,"file":"routes.js","sources":["routes.js","migrate.js"],"names":["define","ResultServerMgt","actions","migrate","module","$","__","context","helpers","feedback","migrateRunner","start","click","source","operation","this","attr","sources","targets","$source","$target","$migrationDialog","$migrationInfo","children","migrateDataUrl","root_url","empty","each","val","push","append","id","replace","html","parent","text","length","show","dialog","modal","width","height","buttons","hide","addClass","off","ajax","url","type","dataType","data","target","success","info","error","status","$ul","class","i","uri","testTakers","deliveries","callIds","prepend"],"mappings":"AAqBAA,OAAA,uCAAA,WACA,YAEA,QACAC,iBAEAC,SACAC,QAAA,0BCRAH,OAAA,sCAAA,SAAA,SAAA,OAAA,UAAA,UAAA,eACA,SAAAI,OAAAC,EAAAC,GAAAC,QAAAC,QAAAC,UAEA,GAAAC,gBACAC,MAAA,WACAN,EAAA,aAAAO,MAEA,WAEA,GAOAC,QAPAC,UAAAT,EAAAU,MAAAC,KAAA,MACAC,WACAC,WACAC,QAAAd,EAAA,cACAe,QAAAf,EAAA,cACAgB,iBAAAhB,EAAA,sBACAiB,eAAAD,iBAAAE,SAAA,kBAIAC,eAAAjB,QAAAkB,SAAA,6CAcA,OAXAN,SAAAO,QACAN,QAAAM,QAEArB,EAAA,2BAAAsB,KAAA,WACAd,OAAAR,EAAAU,MAAAa,MACAX,QAAAY,KAAAhB,QAEAM,QACAW,OAAAzB,EAAA,UAAA0B,GAAAlB,OAAAmB,QAAA,iBAAA,OACAC,KAAA5B,EAAAU,MAAAmB,SAAAC;GAEAlB,QAAAmB,QAKA/B,EAAA,2BAAAsB,KAAA,WACAT,QAAAW,KAAAxB,EAAAU,MAAAa,OAEAR,QAAAU,OAAAzB,EAAA,UAAA8B,KAAA9B,EAAAU,MAAAmB,SAAAC,WAEAjB,QAAAkB,QAKA/B,EAAA,iBAAA4B,KAAA,UAAAnB,UAAA,YAEAQ,eAAAC,WAAAc,WAEAhB,kBACAL,KAAA,QAAA,uBACAsB,QACAC,OAAA,EACAC,MAAA,IACAC,OAAA,IACAC,UAEAX,GAAA,iBACAI,KAAA7B,GAAA,UAEAM,MAAA,WACAP,EAAAU,MAAAuB,OAAA,YAIAP,GAAA,iBACAI,KAAA7B,GAAA,WACAM,MAAA,WACAU,eAAAqB,OACAtB,iBAAAE,SAAA,oBAAAoB,OACAtB,iBAAAE,SAAA,sBAAAc,OACAhC,EAAA,mBAAAuC,SAAA,YAAAC,IAAA,SAEAxC,EAAAyC,MACAC,IAAAvB,eACAwB,KAAA,OACAC,SAAA,OACAC,MACArC,OAAAI,QACAkC,OAAAjC,QACAJ,UAAAA,WAEAsC,QAAA,SAAAF,MAIA,GAFA7B,iBAAAE,SAAA,sBAAAoB,QAEAO,KAAAE,QAGA,MAFAC,MAAAhB,WACA5B,YAAA6C,MAAAJ,KAAAK,OAIAjC;eAAAC,SAAA,oBAAAoB,MAEA,IACAZ,IADAyB,IAAAnD,EAAA,SAAAoD,QAAA,iBAEApD,GAAAsB,KAAAuB,KAAAA,KAAA,SAAAQ,EAAA7C,QACAkB,GAAAlB,OAAA8C,IAAA3B,QAAA,iBAAA,KACAwB,IAAA1B,OAAAzB,EAAA,UAAA8B,KAAAtB,OAAA+C,WAAAtD,GAAA,mBACAkD,IAAA1B,OAAAzB,EAAA,UAAA8B,KAAAtB,OAAAgD,WAAAvD,GAAA,kBACAkD,IAAA1B,OAAAzB,EAAA,UAAA8B,KAAAtB,OAAAiD,QAAAxD,GAAA,gBACAD,EAAA,IAAA0B,IAAAa,SAAA,WAAAd,OAAA0B,OAGAnD,EAAA,cAAA0D,QAAA1D,EAAA,SAAA8B,KAAAe,KAAAK,UACAjC,eAAAe,OACAhC,EAAA,mBAAA8B,KAAA7B,GAAA,UACAG,WAAA2C,QAAAF,KAAAK,SAEAD,MAAA,WACAjC,iBAAAE,SAAA,sBAAAoB,OACArB,eAAAe,oBAtEA5B,YAAA6C,MAAAhD,GAAA,4CAVAG,YAAA6C,MAAAhD,GAAA;IAgGA,OAAAI","sourcesContent":["/**\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; under version 2\n * of the License (non-upgradable).\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n *\n * Copyright (c) 2014 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\n * \n * \n */\n\n//@see http://forge.taotesting.com/projects/tao/wiki/Front_js\ndefine('taoResultServer/controller/routes',[],function(){\n    'use strict';\n\n    return {\n        'ResultServerMgt': {\n           // 'deps' : 'controller/migrate'\n            'actions': {\n                'migrate' : 'controller/migrate'\n            }\n            \n        }\n    };\n});\n\n","/**\r\n * This program is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU General Public License\r\n * as published by the Free Software Foundation; under version 2\r\n * of the License (non-upgradable).\r\n *\r\n * This program is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU General Public License\r\n * along with this program; if not, write to the Free Software\r\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\r\n *\r\n * Copyright (c) 2013 (original work) Open Assessment Technologies SA (under the project TAO-PRODUCT);\r\n *\r\n *\r\n */\r\n\r\ndefine('taoResultServer/controller/migrate',['module', 'jquery','i18n', 'context', 'helpers', 'ui/feedback'], \r\n        function(module, $, __, context, helpers, feedback){\r\n    \r\n        var migrateRunner = {\r\n            start : function(options){\r\n               $('.opButton').click(\r\n                       \r\n                            function(e) {\r\n\r\n                                var operation = $(this).attr(\"id\"),\r\n                                    sources = [],\r\n                                    targets = [],\r\n                                    $source = $(\"#selSource\"),\r\n                                    $target = $(\"#selTarget\"),\r\n                                    $migrationDialog = $(\"#migrationProgress\"),\r\n                                    $migrationInfo = $migrationDialog.children(\".migrationInfo\"),\r\n                                    source;\r\n\r\n                                //todo move\r\n                                var migrateDataUrl = context.root_url+'taoResultServer/ResultServerMgt/migrateData';\r\n\r\n                                //clean any former feedback built in the dom\r\n                                $source.empty();\r\n                                $target.empty();\r\n\r\n                                $('#sourceStorage :checked').each(function() {\r\n                                    source = $(this).val();\r\n                                    sources.push(source);\r\n\r\n                                    $source\r\n                                        .append($(\"<li />\", {id: source.replace(/[^a-z0-9-_]+/ig, \"_\")})\r\n                                        .html($(this).parent().text()));\r\n                                });\r\n                                if (!sources.length) {\r\n                                  feedback().error(__('Please select a migration source'));\r\n                                  return;\r\n                                }\r\n\r\n                                $(\"#targetStorage :checked\").each(function() {\r\n                                    targets.push($(this).val());\r\n\r\n                                    $target.append($(\"<li />\").text($(this).parent().text()));\r\n                                });\r\n                                if (!targets.length) {\r\n                                  feedback().error(__(\"Please select a destination target\"));\r\n                                  return;\r\n                                }\r\n\r\n                                $(\"#selOperation\").html(\"<label>\"+operation+\"</label>\");\r\n\r\n                                $migrationInfo.children().show();\r\n\r\n                                $migrationDialog\r\n                                    .attr(\"style\", \"visibility: visible\")\r\n                                    .dialog({\r\n                                        modal: true,\r\n                                        width: 500,\r\n                                        height: 430,\r\n                                        buttons: [\r\n                                                {\r\n                                                        id: \"MigrationClose\",\r\n                                                        text: __('Cancel'),\r\n                                                        \r\n                                                        click: function() {\r\n                                                                $(this).dialog('close');\r\n                                                        }\r\n                                                },\r\n                                                {\r\n                                                        id: \"MigrationStart\",\r\n                                                        text: __('Migrate'),\r\n                                                        click: function() {\r\n                                                            $migrationInfo.hide();\r\n                                                            $migrationDialog.children(\".migrationResult\").hide();\r\n                                                            $migrationDialog.children(\".migrationProgress\").show();\r\n                                                            $(\"#MigrationStart\").addClass(\"disabled\").off(\"click\");\r\n\r\n                                                            $.ajax({\r\n                                                              url: migrateDataUrl,\r\n                                                              type: \"POST\",\r\n                                                              dataType: \"JSON\",\r\n                                                              data: {   \r\n                                                                   source: sources,\r\n                                                                   target: targets,\r\n                                                                   operation: operation\r\n                                                              },\r\n                                                              success: function(data){\r\n\r\n                                                                  $migrationDialog.children(\".migrationProgress\").hide();\r\n\r\n                                                                  if (!data.success) {\r\n                                                                      info.show();\r\n                                                                      feedback().error(data.status);\r\n                                                                      return;\r\n                                                                  }\r\n\r\n                                                                  $migrationInfo.children(\":not(#selSource)\").hide();\r\n\r\n                                                                  var $ul = $(\"<ul/>\", {class: \"StorageResult\"}),\r\n                                                                      id;\r\n                                                                  $.each(data.data, function(i, source){\r\n                                                                      id = source.uri.replace(/[^a-z0-9-_]+/ig, \"_\");\r\n                                                                      $ul.append($('<li />', {text: source.testTakers + __(\" test takers\")}));\r\n                                                                      $ul.append($('<li />', {text: source.deliveries + __(\" deliveries\")}));\r\n                                                                      $ul.append($('<li />', {text: source.callIds + __(\" call ids\")}));\r\n                                                                      $(\"#\" + id).addClass(\"success\").append($ul);\r\n                                                                  });\r\n\r\n                                                                  $(\"#selSource\").prepend($(\"<h3/>\", {text: data.status}));\r\n                                                                  $migrationInfo.show();\r\n                                                                  $(\"#MigrationClose\").text(__(\"Close\"));\r\n                                                                  feedback().success(data.status);\r\n                                                              },\r\n                                                              error : function(){\r\n                                                                  $migrationDialog.children(\".migrationProgress\").hide();\r\n                                                                  $migrationInfo.show();\r\n                                                              }\r\n                                                            });\r\n                                                            \r\n                                                            \r\n                                                        }\r\n                                                }\r\n                                        ],\r\n\r\n                                });\r\n                            }\r\n               );\r\n\r\n         }\r\n       };\r\n   \r\n        return migrateRunner;\r\n});\n"]}